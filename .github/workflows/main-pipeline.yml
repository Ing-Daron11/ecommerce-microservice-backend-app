name: Master CI/CD Pipeline - Build, Secure & Deploy

on:
  push:
    branches: [ "ci/cd-advanced-pipelines", "dev"] # Se dispara al hacer push a esta rama
  workflow_dispatch: # Permite ejecución manual

env:
  ACR_NAME: ecommercestageacr
  IMAGE_TAG: ${{ github.sha }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ==============================================================================
  # JOB 1: CI - Build, Test, SonarCloud & Trivy
  # ==============================================================================
  build-and-secure:
    name: Build & Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Importante para SonarCloud

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # 1. Quality Analysis with SonarCloud
      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.projectKey=Ing-Daron11_ecommerce-microservice-backend-app \
          -Dsonar.organization=ing-daron11 \
          -Dsonar.host.url=https://sonarcloud.io \
          -DskipTests # Ejecutamos tests en paso aparte si se desea, o aquí mismo quitando esto

      # 2. Build Microservices (Maven) & Run Unit Tests
      - name: Build & Unit Tests
        run: mvn clean package 

      # 3. Login to Azure Container Registry
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 4. Build & Push Docker Images + Trivy Scan
      # We loop through all services
      - name: Build, Scan & Push Images
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '0' # 0 = No fallar el pipeline por vulnerabilidades, 1 = Sí falla
          severity: 'CRITICAL,HIGH'
      
      - name: Build & Push All Services
        run: |
          # List of services
          services="api-gateway cloud-config favourite-service order-service payment-service product-service proxy-client service-discovery shipping-service user-service"
          
          for service in $services; do
            echo "Processing $service..."
            
            # Build Docker Image
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:${{ env.IMAGE_TAG }} ./$service
            docker tag ${{ secrets.ACR_LOGIN_SERVER }}/$service:${{ env.IMAGE_TAG }} ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
            
            # Push to ACR
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:${{ env.IMAGE_TAG }}
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
          done

  # ==============================================================================
  # JOB 2: CD - Deploy to STAGE & Run E2E Tests
  # ==============================================================================
  deploy-stage:
    name: Deploy to STAGE & E2E Tests
    needs: build-and-secure
    runs-on: ubuntu-latest
    environment: 
      name: stage
      url: http://4.246.232.222:8080 # URL del API Gateway en Stage
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context (Stage)
        uses: azure/aks-set-context@v3
        with:
          resource-group: ecommerce-stage-rg
          cluster-name: ecommerce-stage-aks

      - name: Clean Previous Deployments (Avoid Resource Deadlock)
        run: |
          echo "Deleting existing deployments to free up resources..."
          kubectl delete deployment --all --ignore-not-found=true
          # Esperar un poco para asegurar que se liberen recursos
          sleep 30

      - name: Update Kubernetes Manifests (Image Tag)
        run: |
          # Replace 'latest' or fixed versions with the current commit TAG
          find k8s -name "*.yaml" -exec sed -i "s|ecommercestageacr.azurecr.io/\(.*\):.*|ecommercestageacr.azurecr.io/\1:${{ env.IMAGE_TAG }}|g" {} +

      - name: Deploy to AKS (Stage)
        run: |
          kubectl apply -f k8s/
      
      - name: Wait for Pods to be Ready
        run: |
          echo "Waiting for pods to be ready (timeout 10m)..."
          kubectl wait --for=condition=ready pod --all --timeout=900s || echo "Some pods are not ready yet, proceeding to tests anyway..."

      # E2E TESTS
      - name: Install Newman (Postman Runner)
        run: npm install -g newman

      - name: Run E2E Tests
        shell: pwsh
        run: |
          cd e2e
          ./run-e2e-tests.ps1 -Environment azure -BaseUrl "http://4.246.232.222:8080"

  # ==============================================================================
  # JOB 3: CD - Deploy to PROD (Requires Approval)
  # ==============================================================================
  deploy-prod:
    name: Deploy to PROD
    needs: deploy-stage
    runs-on: ubuntu-latest
    environment: 
      name: production # ESTO ACTIVA LA REGLA DE APROBACIÓN MANUAL EN GITHUB
      url: http://52.160.122.32:8080 # URL del API Gateway en Prod
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context (Prod)
        uses: azure/aks-set-context@v3
        with:
          resource-group: ecommerce-prod-rg
          cluster-name: ecommerce-prod-aks

      - name: Clean Previous Deployments (Avoid Resource Deadlock)
        run: |
          echo "Deleting existing deployments to free up resources..."
          kubectl delete deployment --all --ignore-not-found=true
          sleep 30

      - name: Update Kubernetes Manifests (Image Tag)
        run: |
          # Misma lógica: Usamos el MISMO tag que en Stage (Promoción de Artefacto)
          find k8s -name "*.yaml" -exec sed -i "s|ecommercestageacr.azurecr.io/\(.*\):.*|ecommercestageacr.azurecr.io/\1:${{ env.IMAGE_TAG }}|g" {} +

      - name: Deploy to AKS (Prod)
        run: |
          kubectl apply -f k8s/
