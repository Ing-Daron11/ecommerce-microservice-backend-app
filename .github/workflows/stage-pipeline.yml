name: STAGE Pipeline - Build, Deploy to Minikube and Integration Tests

on:
  push:
    branches:
      - master
    paths:
      - 'user-service/**'
      - 'proxy-client/**'
      - '.github/workflows/stage-pipeline.yml'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx1024m
  MINIKUBE_PROFILE: minikube

jobs:
  build-deploy-and-test:
    name: Build, Deploy to Minikube and Run Integration Tests
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build user-service
        working-directory: ./user-service
        run: mvn clean package -DskipTests

      - name: Build proxy-client
        working-directory: ./proxy-client
        run: mvn clean package -DskipTests

      - name: Check Minikube status
        run: |
          minikube status
          if ($LASTEXITCODE -ne 0) {
            echo "Starting Minikube..."
            minikube start --driver=docker
          }

      - name: Build Docker images in Minikube
        run: |
          Write-Host "Setting Docker environment to Minikube..."
          minikube -p minikube docker-env --shell powershell | Invoke-Expression
          
          Write-Host "Building user-service image..."
          docker build -f user-service/Dockerfile -t user-service:v0.1.0 .
          
          Write-Host "Building proxy-client image..."
          docker build -f proxy-client/Dockerfile -t proxy-client:v0.1.0 .
          
          Write-Host "Images built successfully"

      - name: Verify images in Minikube
        run: |
          minikube ssh "docker images | grep -E 'user-service|proxy-client'"

      - name: Deploy to Kubernetes
        run: |
          Write-Host "Deploying to Kubernetes..."
          
          kubectl set image deployment/user-service user-service=user-service:v0.1.0 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Deployment may need creation" }
          
          kubectl set image deployment/proxy-client proxy-client=proxy-client:v0.1.0 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "Deployment may need creation" }
          
          Write-Host "Restarting deployments..."
          kubectl rollout restart deployment/user-service 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "user-service deployment restarted or created" }
          
          kubectl rollout restart deployment/proxy-client 2>$null
          if ($LASTEXITCODE -ne 0) { Write-Host "proxy-client deployment restarted or created" }
          
          Write-Host "Waiting for deployments to stabilize..."
          Start-Sleep -Seconds 15
          
          kubectl get pods
          kubectl get deployments

      - name: Run integration tests for user-service
        working-directory: ./user-service
        run: |
          Write-Host "Running integration tests for user-service..."
          mvn test -Dtest='*IntegrationTest' -DfailIfNoTests=false
          Write-Host "Integration tests completed"

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            user-service/target/surefire-reports/
            user-service/target/site/
          retention-days: 30

      - name: Generate test report
        if: always()
        working-directory: ./user-service
        run: |
          Write-Host "## Integration Test Results" >> $env:GITHUB_STEP_SUMMARY
          mvn surefire-report:report-only
