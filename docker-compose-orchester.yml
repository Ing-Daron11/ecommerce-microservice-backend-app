version: '3.8'

services:
  # ============================================
  # 1. ZIPKIN - Distributed Tracing
  # ============================================
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin-server
    ports:
      - "9411:9411"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9411/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # 2. SERVICE DISCOVERY - Eureka Server
  # ============================================
  service-discovery:
    image: ecommerce/service-discovery:0.1.0
    container_name: service-discovery
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_ZIPKIN_BASE_URL=http://zipkin:9411/
    networks:
      - ecommerce-network
    depends_on:
      zipkin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 3. CLOUD CONFIG - Configuration Server
  # ============================================
  cloud-config:
    image: ecommerce/cloud-config:0.1.0
    container_name: cloud-config
    ports:
      - "9296:9296"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_ZIPKIN_BASE_URL=http://zipkin:9411/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
    networks:
      - ecommerce-network
    depends_on:
      service-discovery:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9296/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 4. API GATEWAY - Gateway Server
  # ============================================
  api-gateway:
    image: ecommerce/api-gateway:0.1.0
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_ZIPKIN_BASE_URL=http://zipkin:9411/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://cloud-config:9296
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
    networks:
      - ecommerce-network
    depends_on:
      cloud-config:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 5. PROXY CLIENT - Authentication & Authorization
  # ============================================
  proxy-client:
    image: ecommerce/proxy-client:0.1.0
    container_name: proxy-client
    ports:
      - "8900:8900"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_ZIPKIN_BASE_URL=http://zipkin:9411/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://cloud-config:9296
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
    networks:
      - ecommerce-network
    depends_on:
      cloud-config:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8900/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 6. USER SERVICE - Business Logic
  # ============================================
  user-service:
    image: ecommerce/user-service:0.1.0
    container_name: user-service
    ports:
      - "8700:8700"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_ZIPKIN_BASE_URL=http://zipkin:9411/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://cloud-config:9296
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
    networks:
      - ecommerce-network
    depends_on:
      cloud-config:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8700/user-service/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

# ============================================
# NETWORKS
# ============================================
networks:
  ecommerce-network:
    driver: bridge
    name: ecommerce-network
